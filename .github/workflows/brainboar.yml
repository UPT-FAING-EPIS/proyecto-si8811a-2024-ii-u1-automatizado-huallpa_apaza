name: Generate Infrastructure Diagrams

on:
  push:
    branches:
      - DesarrolloApiBack

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/DesarrolloApiBack'

    steps:
      - name: Checkout the main repository
        uses: actions/checkout@v3

      - name: Checkout the Terraform repository
        uses: actions/checkout@v3
        with:
          repository: UPT-FAING-EPIS/proyecto-si8811a-2024-ii-u1-desarrollo-api-back
          path: terraform_repo
          ref: develop

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y graphviz
          sudo apt install -y make  # Ensure make is installed for building
          # Install any other dependencies needed here

      - name: Clone and Install Terraform Visual
        run: |
          git clone https://github.com/mahmoudshakir/terraform-visual.git
          cd terraform-visual
          sudo make install  # Make sure this completes successfully

      - name: Check terraform-visual Installation
        run: |
          if ! command -v terraform-visual &> /dev/null; then
              echo "terraform-visual could not be found"
              exit 1
          fi

      - name: Generate PNG Diagrams
        run: |
          for tf_file in $(find terraform_repo -name "main.tf"); do
              echo "Generating diagram for $tf_file"
              terraform-visual -f "$tf_file" -o "${tf_file%.tf}.png"
          done

      - name: Commit and Push Diagrams
        run: |
          git config --local user.name "jesus huallpa"
          git config --local user.email "jh2021071085@virtual.upt.pe"
          git add *.png  # Adjust the pattern if needed
          git commit -m "Automatically generate infrastructure diagrams" || echo "No changes to commit"
          git push origin DesarrolloApiBack

