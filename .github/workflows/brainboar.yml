name: Generate Infrastructure Diagrams

on:
  push:
    branches:
      - DesarrolloApiBack
      - main

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/DesarrolloApiBack'  # Only run this job on DesarrolloApiBack

    steps:
      - name: Checkout the main repository
        uses: actions/checkout@v3

      - name: Checkout the Terraform repository
        uses: actions/checkout@v3
        with:
          repository: UPT-FAING-EPIS/proyecto-si8811a-2024-ii-u1-desarrollo-api-back
          path: terraform_repo
          ref: develop

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'  # Specify the correct version

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y graphviz
          # Install Node.js and npm
          sudo apt install -y nodejs npm
          # Update npm to the latest version
          sudo npm install -g npm@latest
          # Install terraform-visual globally
          sudo npm install -g terraform-visual --verbose

      - name: Generate PNG Diagrams
        run: |
          for tf_file in $(find terraform_repo -name "main.tf"); do
              echo "Generating diagram for $tf_file"
              terraform-visual -f "$tf_file" -o "${tf_file%.tf}.png"
          done

      - name: Commit and Push Diagrams
        run: |
          git config --local user.name "jesus huallpa"
          git config --local user.email "jh2021071085@virtual.upt.pe"
          git add *.png  # Ensure the generated images are in the root or adjust the pattern
          if git commit -m "Automatically generate infrastructure diagrams"; then
            git push origin DesarrolloApiBack
          else
            echo "No changes to commit"
          fi

  install:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only run this job on main

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y graphviz
          # Install Node.js and npm
          sudo apt install -y nodejs npm
          # Update npm to the latest version
          sudo npm install -g npm@latest
          # Install terraform-visual globally
          sudo npm install -g terraform-visual --verbose
