name: Generate Infrastructure Diagram

on:
  push:
    branches:
      - DesarrolloApiBack

jobs:
  generate-diagram:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the main repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install diagrams

      - name: Generate Diagram with Diagrams as Code
        run: |
          echo "
          from diagrams import Diagram, Cluster
          from diagrams.aws.compute import EC2
          from diagrams.aws.database import RDS
          from diagrams.aws.network import ELB

          with Diagram('Infrastructure Diagram', show=False, filename='infra_diagram', outformat='png'):
              lb = ELB('Load Balancer')
              
              with Cluster('Web Servers'):
                  web1 = EC2('web1')
                  web2 = EC2('web2')
                  
              with Cluster('Database Cluster'):
                  db_primary = RDS('Primary DB')
                  db_primary - [RDS('Replica DB1'), RDS('Replica DB2')]

              lb >> web1
              lb >> web2
              web1 >> db_primary
              web2 >> db_primary
          " > generate_diagram.py
          python generate_diagram.py

      - name: Commit and Push Diagram
        run: |
          git config --local user.name "jesus huallpa"
          git config --local user.email "jh2021071085@virtual.upt.pe"
          git add infra_diagram.png
          git commit -m "Agregar diagrama de infraestructura en PNG" || echo "No hay cambios para commit"
          git push origin DesarrolloApiBack

      - name: Upload Diagram as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: infra_diagram
          path: infra_diagram.png

